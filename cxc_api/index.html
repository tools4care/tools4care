<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CxC Mini Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) para estilos rápidos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel (para JSX sin build) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root" class="max-w-7xl mx-auto p-4"></div>

  <script type="text/babel">
  // 👇 Lee ?api= de la URL o usa tu túnel actual como fallback
  const API = new URLSearchParams(location.search).get('api')
    || 'https://nominations-himself-broadband-speeches.trycloudflare.com';



    const currency = (n) =>
      new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(n || 0));

    function useFetch(initialUrl = null, initialData = null) {
      const [data, setData] = React.useState(initialData);
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState(null);

      const run = async (url, options) => {
        setLoading(true);
        setError(null);
        try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          setData(json);
        } catch (e) {
          setError(e.message);
        } finally {
          setLoading(false);
        }
      };

      React.useEffect(() => {
        if (initialUrl) run(initialUrl);
      }, [initialUrl]);

      return { data, loading, error, run, setData };
    }

    function Header() {
      return (
        <header className="mb-4">
          <h1 className="text-2xl md:text-3xl font-bold">CxC Dashboard</h1>
          <p className="text-sm text-slate-500">Resumen, aging y detalle por cliente</p>
        </header>
      );
    }

    function Filters({ minSaldo, setMinSaldo, limit, setLimit, onReload }) {
      return (
        <div className="flex flex-col md:flex-row gap-3 items-start md:items-end bg-white p-4 rounded-xl shadow">
          <div>
            <label className="block text-sm font-medium">Mín. saldo</label>
            <input
              type="number" step="0.01" value={minSaldo}
              onChange={(e)=>setMinSaldo(e.target.value)}
              className="border rounded px-3 py-2 w-40"
            />
          </div>
          <div>
            <label className="block text-sm font-medium">Límite</label>
            <input
              type="number" value={limit}
              onChange={(e)=>setLimit(e.target.value)}
              className="border rounded px-3 py-2 w-40"
            />
          </div>
          <button
            onClick={onReload}
            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
          >
            Recargar
          </button>
        </div>
      );
    }

    function ResumenTable({ rows, onSelect }) {
      return (
        <div className="overflow-auto rounded-xl shadow bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-slate-100 text-slate-600">
              <tr>
                <th className="text-left p-3">Cliente</th>
                <th className="text-left p-3">Teléfono</th>
                <th className="text-right p-3">Ventas con saldo</th>
                <th className="text-right p-3">Saldo</th>
                <th className="p-3"></th>
              </tr>
            </thead>
            <tbody>
              {rows?.map((r) => (
                <tr key={r.cliente_id} className="border-t">
                  <td className="p-3">{r.cliente}</td>
                  <td className="p-3">{r.telefono || '—'}</td>
                  <td className="p-3 text-right">{r.ventas_con_saldo}</td>
                  <td className="p-3 text-right font-semibold">{currency(r.saldo_cliente)}</td>
                  <td className="p-3 text-right">
                    <button
                      className="text-blue-700 hover:underline"
                      onClick={()=>onSelect(r)}
                    >
                      Ver detalle
                    </button>
                  </td>
                </tr>
              ))}
              {(!rows || rows.length===0) && (
                <tr><td colSpan="5" className="p-4 text-center text-slate-500">Sin datos</td></tr>
              )}
            </tbody>
          </table>
        </div>
      );
    }

    function AgingCard({ item }) {
      return (
        <div className="bg-white rounded-xl shadow p-4">
          <div className="font-semibold">{item.cliente}</div>
          <div className="text-xs text-slate-500 mb-2">{item.cliente_id}</div>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <div className="flex justify-between"><span>0–30</span><span>{currency(item.d0_30)}</span></div>
            <div className="flex justify-between"><span>31–60</span><span>{currency(item.d31_60)}</span></div>
            <div className="flex justify-between"><span>61–90</span><span>{currency(item.d61_90)}</span></div>
            <div className="flex justify-between"><span>90+</span><span>{currency(item.d90_plus)}</span></div>
          </div>
          <div className="mt-2 flex justify-between font-semibold">
            <span>Total</span><span>{currency(item.total)}</span>
          </div>
        </div>
      );
    }

    // Helpers para WhatsApp
    const normalizePhone = (raw) => {
      if (!raw) return "";
      const digits = String(raw).replace(/\D/g, "");
      if (digits.length === 11 && digits.startsWith("1")) return `+${digits}`; // US con 1
      if (digits.length === 10) return `+1${digits}`; // asume US si 10 dígitos
      return digits.startsWith("+") ? digits : `+${digits}`;
    };
    const openWhatsAppWith = (telefono, texto) => {
      const to = normalizePhone(telefono);
      if (!to) { alert("Este cliente no tiene teléfono válido."); return; }
      const url = `https://wa.me/${to.replace("+","")}?text=${encodeURIComponent(texto || "")}`;
      window.open(url, "_blank");
    };

    function DetalleCliente({ cliente, onClose }) {
      const { data: detalle, loading, error, run } = useFetch();
      const { data: recData, run: runRec } = useFetch();
      const [mensaje, setMensaje] = React.useState("");

      React.useEffect(()=>{
        if (cliente?.cliente_id) {
          run(`${API}/cxc/clientes/${cliente.cliente_id}/pendientes`);
          setMensaje("");
        }
      }, [cliente?.cliente_id]);

      const generarSugerencia = async () => {
        await runRec(`${API}/cxc/clientes/${cliente.cliente_id}/recordatorio`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}) // opcional: { plantilla: "Hi {cliente}, ..." }
        });
      };

      React.useEffect(()=>{
        if (recData?.mensaje_sugerido) setMensaje(recData.mensaje_sugerido);
      }, [recData]);

      const copyToClipboard = async () => {
        try {
          await navigator.clipboard.writeText(mensaje || "");
          alert("Message copied ✅");
        } catch {
          alert("Couldn't copy automatically. Please select and copy manually.");
        }
      };

      return (
        <div className="fixed inset-0 bg-black/30 flex items-end md:items-center justify-center p-3 z-50">
          <div className="bg-white w-full md:max-w-3xl rounded-2xl shadow-lg">
            <div className="p-4 border-b flex items-center justify-between">
              <div>
                <div className="font-bold text-lg">{cliente.cliente}</div>
                <div className="text-sm text-slate-500">{cliente.telefono || 'No phone'}</div>
              </div>
              <button onClick={onClose} className="text-slate-600 hover:text-slate-900">✕</button>
            </div>

            <div className="p-4 space-y-4">
              {/* Detalle de facturas */}
              <div>
                {loading && <div className="text-sm text-slate-500">Loading detail…</div>}
                {error && <div className="text-sm text-red-600">Error: {error}</div>}
                {!loading && !error && (
                  <div className="overflow-auto rounded border">
                    <table className="min-w-full text-sm">
                      <thead className="bg-slate-100">
                        <tr>
                          <th className="text-left p-2">Factura</th>
                          <th className="text-left p-2">Fecha</th>
                          <th className="text-right p-2">Pendiente</th>
                          <th className="text-right p-2">Días</th>
                        </tr>
                      </thead>
                      <tbody>
                        {detalle?.map((d) => (
                          <tr key={d.numero_factura} className="border-t">
                            <td className="p-2">{d.numero_factura}</td>
                            <td className="p-2">{d.fecha?.slice(0,10)}</td>
                            <td className="p-2 text-right">
                              {new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(d.pendiente||0)}
                            </td>
                            <td className="p-2 text-right">{d.dias}</td>
                          </tr>
                        ))}
                        {(!detalle || detalle.length===0) && (
                          <tr><td colSpan="4" className="p-3 text-center text-slate-500">Sin pendientes</td></tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {/* Zona de recordatorio */}
              <div className="border rounded-xl p-3 bg-slate-50">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold">Reminder message</div>
                  {!recData && (
                    <button
                      onClick={generarSugerencia}
                      className="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-sm"
                    >
                      Generate suggestion
                    </button>
                  )}
                </div>

                {recData && (
                  <>
                    <textarea
                      className="w-full border rounded-lg p-2 text-sm h-28"
                      value={mensaje}
                      onChange={e=>setMensaje(e.target.value)}
                    />
                    <div className="mt-2 flex flex-wrap gap-2">
                      <button onClick={copyToClipboard}
                              className="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded-lg text-sm">
                        Copy
                      </button>
                      <button onClick={() => openWhatsAppWith(recData?.telefono, mensaje)}
                              className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm">
                        WhatsApp
                      </button>
                    </div>
                    <div className="mt-2 text-xs text-slate-500">
                      Total: {new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'})
                        .format(recData?.saldo_total||0)} • Tel: {recData?.telefono || '—'}
                    </div>
                  </>
                )}

                {!recData && (
                  <div className="text-xs text-slate-500">
                    Click “Generate suggestion” to create the message with the total and detail.
                  </div>
                )}
              </div>

              {/* Botonera inferior */}
              <div className="flex gap-2 justify-end">
                {!recData && (
                  <button
                    onClick={generarSugerencia}
                    className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg"
                  >
                    Generate reminder
                  </button>
                )}
                <button
                  onClick={onClose}
                  className="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [minSaldo, setMinSaldo] = React.useState(0.05);
      const [limit, setLimit] = React.useState(50);
      const [showAging, setShowAging] = React.useState(false);
      const [selected, setSelected] = React.useState(null);

      const resumenUrl = `${API}/cxc/resumen?min_saldo=${minSaldo}&limit=${limit}`;
      const agingUrl   = `${API}/cxc/aging?min_total=${minSaldo}&limit=${limit}`;

      const { data: resumen, loading: l1, error: e1, run: runResumen } = useFetch(resumenUrl);
      const { data: aging,   loading: l2, error: e2, run: runAging   } = useFetch();

      const reload = () => runResumen(resumenUrl);
      const loadAging = () => {
        setShowAging(true);
        runAging(agingUrl);
      };

      return (
        <div className="space-y-4">
          <Header />
          <div className="flex flex-wrap gap-2">
            <button
              className={`px-3 py-2 rounded-lg ${!showAging ? 'bg-blue-600 text-white' : 'bg-white border'}`}
              onClick={()=>setShowAging(false)}
            >
              Resumen
            </button>
            <button
              className={`px-3 py-2 rounded-lg ${showAging ? 'bg-blue-600 text-white' : 'bg-white border'}`}
              onClick={loadAging}
            >
              Aging
            </button>
          </div>

          {!showAging && (
            <>
              <Filters
                minSaldo={minSaldo}
                setMinSaldo={setMinSaldo}
                limit={limit}
                setLimit={setLimit}
                onReload={reload}
              />
              {l1 && <div className="text-sm text-slate-500">Cargando…</div>}
              {e1 && <div className="text-sm text-red-600">Error: {e1}</div>}
              {!l1 && !e1 && <ResumenTable rows={resumen} onSelect={setSelected} />}
            </>
          )}

          {showAging && (
            <div className="space-y-3">
              <div className="flex items-end gap-3">
                <div className="text-sm text-slate-600">Min total: {currency(minSaldo)}</div>
                <button onClick={loadAging} className="px-3 py-2 rounded-lg bg-white border">Refrescar</button>
              </div>
              {l2 && <div className="text-sm text-slate-500">Cargando aging…</div>}
              {e2 && <div className="text-sm text-red-600">Error: {e2}</div>}
              {!l2 && !e2 && (
                <div className="grid md:grid-cols-3 gap-3">
                  {aging?.map((a)=> <AgingCard key={a.cliente_id} item={a} />)}
                  {(!aging || aging.length===0) && (
                    <div className="text-sm text-slate-500">Sin datos</div>
                  )}
                </div>
              )}
            </div>
          )}

          {selected && <DetalleCliente cliente={selected} onClose={()=>setSelected(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
